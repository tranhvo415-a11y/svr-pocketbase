# ==============================================================================
# TAILSCALE-CLOUDFLARED CONFIGURATION (LINUX)
# ==============================================================================

services:
  tailscale:
    image: tailscale/tailscale:latest
    hostname: ${DOTENVRTDB_NOW_YYYYDDMMHH:-UNKNOW-DOTENVRTDB_NOW_YYYYDDMMHH}
    network_mode: "host"
    environment:
      - TS_AUTHKEY=${TAILSCALE_CLIENT_SECRET}
      - TS_USERSPACE=false
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SOCKET=/var/run/tailscale/tailscaled.sock
      - TS_EXTRA_ARGS=--advertise-tags=${TAILSCALE_TAGS:-tag:ci} --accept-dns=true --accept-routes
    volumes:
      - tailscale-data:/var/lib/tailscale
      - tailscale-socket:/var/run/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped

  pull-data:
    image: node:20-alpine
    depends_on:
      tailscale:
        condition: service_started
    network_mode: "service:tailscale"
    restart: "no"
    environment:
      - TAILSCALE_TAILNET_DNS=${TAILSCALE_TAILNET_DNS}
      - TAILSCALE_DNS_SETUP_ENABLED=${TAILSCALE_DNS_SETUP_ENABLED:-1}
      - TAILSCALE_DNS_NAMESERVER_PRIMARY=${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - TAILSCALE_DNS_NAMESERVER_FALLBACK=${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
      - TAILSCALE_DNS_SEARCH_DOMAIN=${TAILSCALE_DNS_SEARCH_DOMAIN:-${TAILSCALE_TAILNET_DNS:-}}
      - HOST_CWD=${HOST_CWD:-${PWD}}
      - PULL_DATA_SYNC_DIRS=${PULL_DATA_SYNC_DIRS:-.pocketbase}
      - PULL_DATA_SSH_USER=${PULL_DATA_SSH_USER:-}
      - PULL_DATA_SSH_PORT=${PULL_DATA_SSH_PORT:-${SSH_PORT:-2222}}
      - PULL_DATA_SSH_KNOWN_HOSTS_FILE=${PULL_DATA_SSH_KNOWN_HOSTS_FILE:-}
      - SSH_PULL_DATA_PRIVATE_KEY_BASE64=${SSH_PULL_DATA_PRIVATE_KEY_BASE64:-}
      - TAILSCALE_CLIENT_ID=${TAILSCALE_CLIENT_ID:-${TAILSCALE_CLIENT_ID:-}}
      - TAILSCALE_CLIENT_SECRET=${TAILSCALE_CLIENT_SECRET:-${TAILSCALE_CLIENT_SECRET:-}}
      - TAILSCALE_TAILNET=${TAILSCALE_TAILNET:--}
      - TAILSCALE_API_BASE_URL=${TAILSCALE_API_BASE_URL:-https://api.tailscale.com}
      - PULL_DATA_CWD_PORT=${PULL_DATA_CWD_PORT:-8080}
      - PULL_DATA_HTTP_TIMEOUT_MS=${PULL_DATA_HTTP_TIMEOUT_MS:-5000}
    volumes:
      - ${HOST_CWD:-${PWD}}:${HOST_CWD:-${PWD}}
      - ./scripts/pull-data.js:/opt/pull-data.js:ro
      - ./scripts/setup-resolver.sh:/opt/common/setup-resolver.sh:ro
    entrypoint:
      - /bin/sh
      - -ec
      - |
        if command -v apk >/dev/null 2>&1; then
          apk add --no-cache rsync openssh-client >/dev/null
        fi
        sh /opt/common/setup-resolver.sh
        exec node /opt/pull-data.js

  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    depends_on:
      pull-data:
        condition: service_completed_successfully
    restart: unless-stopped
    environment:
      - PB_HOST=0.0.0.0
      - PB_PORT=${MAIN_PORT:-3000}
      - PB_ADMIN_EMAIL=${PB_ADMIN_EMAIL:-}
      - PB_ADMIN_PASSWORD=${PB_ADMIN_PASSWORD:-}
    ports:
      - "127.0.0.1:${MAIN_PORT:-3000}:${MAIN_PORT:-3000}"
    volumes:
      - ./.pocketbase:/pb_data

  nginx:
    image: nginx:1.27-alpine
    depends_on:
      tailscale:
        condition: service_started
      pull-data:
        condition: service_completed_successfully
    network_mode: "host"
    restart: unless-stopped
    environment:
      - TAILSCALE_DNS_SETUP_ENABLED=${TAILSCALE_DNS_SETUP_ENABLED:-1}
      - TAILSCALE_DNS_NAMESERVER_PRIMARY=${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - TAILSCALE_DNS_NAMESERVER_FALLBACK=${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
      - TAILSCALE_DNS_SEARCH_DOMAIN=${TAILSCALE_DNS_SEARCH_DOMAIN:-${TAILSCALE_TAILNET_DNS:-}}
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
      - HOST_CWD=${HOST_CWD:-${PWD}}
      - MAIN_PORT=${MAIN_PORT:-3000}
      - MAIN_TARGET_DNS=${MAIN_TARGET_DNS:-127.0.0.1}
      - MAIN_TARGET_PORT=${MAIN_TARGET_PORT:-${MAIN_PORT:-3000}}
      - NGINX_PORT=${NGINX_PORT:-8080}
      - DOCKER_MANAGER_PORT=${DOCKER_MANAGER_PORT:-18080}
      - NGINX_AUTH_USER_00=${NGINX_AUTH_USER_00:-}
      - NGINX_AUTH_PASS_00=${NGINX_AUTH_PASS_00:-}
      - NGINX_AUTH_USER_01=${NGINX_AUTH_USER_01:-}
      - NGINX_AUTH_PASS_01=${NGINX_AUTH_PASS_01:-}
    command:
      - /bin/sh
      - -ec
      - |
        export HOST_CWD="$${HOST_CWD:-$${PWD:-/workspace}}"
        export MAIN_TARGET_DNS="$${MAIN_TARGET_DNS:-127.0.0.1}"
        export MAIN_TARGET_PORT="$${MAIN_TARGET_PORT:-$${MAIN_PORT:-3000}}"
        export NGINX_PORT="$${NGINX_PORT:-8080}"
        export DOCKER_MANAGER_PORT="$${DOCKER_MANAGER_PORT:-18080}"
        export TAILSCALE_DNS_NAMESERVER_PRIMARY="$${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}"
        export TAILSCALE_DNS_NAMESERVER_FALLBACK="$${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}"
        export RUNNER_START_TIME="$${RUNNER_START_TIME:-$$(date -u +%Y-%m-%dT%H:%M:%SZ)}"
        rm -f /etc/nginx/conf.d/default.conf /etc/nginx/http.d/default.conf /etc/nginx/templates/default.conf.template
        sh /opt/nginx/setup-htpasswd.sh
        exec /docker-entrypoint.sh nginx -g 'daemon off;'
    volumes:
      - ${HOST_CWD:-${PWD}}:${HOST_CWD:-${PWD}}:ro
      - ./nginx/conf.d:/etc/nginx/templates/conf.d:ro
      - ./nginx/upstreams:/etc/nginx/templates/upstreams:ro
      - ./nginx/maps:/etc/nginx/maps:ro
      - ./.nginx/runtime/conf.d:/etc/nginx/conf.d
      - ./.nginx/runtime/upstreams:/etc/nginx/upstreams
      - ./.nginx/runtime/auth:/etc/nginx/auth
      - ./.nginx/runtime/shadow-servers:/etc/nginx/shadow-servers
      - ./nginx/scripts:/opt/nginx/scripts:ro
      - ./nginx/setup-htpasswd.sh:/opt/nginx/setup-htpasswd.sh:ro
      - ./.nginx/logs:/var/log/nginx

  docker-manager:
    image: node:20-alpine
    depends_on:
      tailscale:
        condition: service_started
      nginx:
        condition: service_started
    network_mode: "host"
    restart: unless-stopped
    environment:
      - DOCKER_MANAGER_HOST=0.0.0.0
      - DOCKER_MANAGER_PORT=${DOCKER_MANAGER_PORT:-18080}
      - DOCKER_MANAGER_DOCKER_BIN=docker
      - DOCKER_MANAGER_LOG_DIR=/opt/docker-manager-runtime
      - DOCKER_MANAGER_LOG_FILE=${DOCKER_MANAGER_LOG_FILE:-docker-manager.log}
      - DOCKER_MANAGER_MAX_BODY_BYTES=${DOCKER_MANAGER_MAX_BODY_BYTES:-65536}
      - DOCKER_MANAGER_COMMAND_TIMEOUT_MS=${DOCKER_MANAGER_COMMAND_TIMEOUT_MS:-120000}
      - DOCKER_MANAGER_MAX_LOG_LINES=${DOCKER_MANAGER_MAX_LOG_LINES:-2000}
      - DOCKER_MANAGER_DEFAULT_LOG_TAIL=${DOCKER_MANAGER_DEFAULT_LOG_TAIL:-200}
      - DOCKER_MANAGER_TAILSCALE_SYNC_ENABLED=${DOCKER_MANAGER_TAILSCALE_SYNC_ENABLED:-1}
      - DOCKER_MANAGER_TAILSCALE_SYNC_INTERVAL_SEC=${DOCKER_MANAGER_TAILSCALE_SYNC_INTERVAL_SEC:-30}
      - DOCKER_MANAGER_TAILSCALE_CONTAINER=${DOCKER_MANAGER_TAILSCALE_CONTAINER:-tailscale}
      - DOCKER_MANAGER_NGINX_CONTAINER=${DOCKER_MANAGER_NGINX_CONTAINER:-nginx}
      - DOCKER_MANAGER_SHADOW_DIR=/opt/nginx/shadow-servers
      - DOCKER_MANAGER_SHADOW_PORT=${DOCKER_MANAGER_SHADOW_PORT:-3000}
      - DOCKER_MANAGER_ENABLE_SAFE_COMMANDS=${DOCKER_MANAGER_ENABLE_SAFE_COMMANDS:-1}
      - DOCKER_MANAGER_ENABLE_DANGEROUS_COMMANDS=${DOCKER_MANAGER_ENABLE_DANGEROUS_COMMANDS:-1}
      - DOCKER_MANAGER_ALLOWED_SAFE_COMMANDS=${DOCKER_MANAGER_ALLOWED_SAFE_COMMANDS:-*}
      - DOCKER_MANAGER_ALLOWED_DANGEROUS_COMMANDS=${DOCKER_MANAGER_ALLOWED_DANGEROUS_COMMANDS:-*}
      - DOCKER_MANAGER_BLOCKED_COMMANDS=${DOCKER_MANAGER_BLOCKED_COMMANDS:-}
      - DOCKER_MANAGER_EXEC_SHELL=${DOCKER_MANAGER_EXEC_SHELL:-sh}
    entrypoint:
      - /bin/sh
      - -ec
      - |
        if command -v apk >/dev/null 2>&1; then
          apk add --no-cache docker-cli >/dev/null
        fi
        mkdir -p /opt/docker-manager-runtime /opt/nginx/shadow-servers
        exec node /opt/docker-manager/index.js
    volumes:
      - ${HOST_CWD:-${PWD}}:${HOST_CWD:-${PWD}}
      - ./docker-manager:/opt/docker-manager:ro
      - ./.docker-manager:/opt/docker-manager-runtime
      - ./.nginx/runtime/shadow-servers:/opt/nginx/shadow-servers
      - /var/run/docker.sock:/var/run/docker.sock

  caddy:
    image: caddy:2-alpine
    depends_on:
      nginx:
        condition: service_started
    network_mode: "host"
    restart: unless-stopped
    environment:
      - TAILSCALE_DNS_SETUP_ENABLED=${TAILSCALE_DNS_SETUP_ENABLED:-1}
      - TAILSCALE_DNS_NAMESERVER_PRIMARY=${TAILSCALE_DNS_NAMESERVER_PRIMARY:-100.100.100.100}
      - TAILSCALE_DNS_NAMESERVER_FALLBACK=${TAILSCALE_DNS_NAMESERVER_FALLBACK:-1.1.1.1}
      - TAILSCALE_DNS_SEARCH_DOMAIN=${TAILSCALE_DNS_SEARCH_DOMAIN:-${TAILSCALE_TAILNET_DNS:-}}
      - CADDY_UPSTREAM_HOST=${CADDY_UPSTREAM_HOST:-127.0.0.1}
      - CADDY_UPSTREAM_PORT=${CADDY_UPSTREAM_PORT:-${NGINX_PORT:-8080}}
    command:
      - /bin/sh
      - -ec
      - |
        sh /opt/caddy/entrypoint.sh
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./caddy/entrypoint.sh:/opt/caddy/entrypoint.sh:ro
      - ./scripts/setup-resolver.sh:/opt/common/setup-resolver.sh:ro
      - ./.caddy:/opt/caddy/runtime
      - caddy-data:/data
      - caddy-config:/config

  cloudflared:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    network_mode: "host"
    command: tunnel --config /etc/cloudflared/config.yml run
    volumes:
      - ./cloudflared-config.yml:/etc/cloudflared/config.yml:ro
      - ./cloudflared-credentials.json:/etc/cloudflared/credentials.json:ro

volumes:
  tailscale-data:
    driver: local
  tailscale-socket:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
